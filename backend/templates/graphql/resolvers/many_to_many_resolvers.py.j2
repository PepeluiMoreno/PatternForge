from ariadne import ObjectType
from sqlalchemy import select, insert, delete
{{ left_import_line }}
{{ right_import_line }}
{{ junction_import_line }}

def mount_many_to_many_resolvers():
    mutation = ObjectType("Mutation")
    left = ObjectType("{{ Left }}")
    right = ObjectType("{{ Right }}")

    @left.field("{{ rights_field }}")
    async def resolve_rights(obj, info, offset: int = 0, limit: int = 50):
        session = info.context["session"]
        J = {{ JunctionModel }}
        res = await session.execute(
            select({{ RightModel }}).join(J, J.{{ left_fk }} == obj.id).where(
                J.{{ right_fk }} == {{ RightModel }}.id
            ).offset(offset).limit(limit)
        )
        return res.scalars().all()

    @right.field("{{ lefts_field }}")
    async def resolve_lefts(obj, info, offset: int = 0, limit: int = 50):
        session = info.context["session"]
        J = {{ JunctionModel }}
        res = await session.execute(
            select({{ LeftModel }}).join(J, J.{{ right_fk }} == obj.id).where(
                J.{{ left_fk }} == {{ LeftModel }}.id
            ).offset(offset).limit(limit)
        )
        return res.scalars().all()

    @mutation.field("{{ link_field }}")
    async def link(*_, leftId: str, rightId: str):
        session = _[1].context["session"]
        await session.execute(insert({{ JunctionModel }}).values({{ left_fk }}=leftId, {{ right_fk }}=rightId))
        return True

    @mutation.field("{{ unlink_field }}")
    async def unlink(*_, leftId: str, rightId: str):
        session = _[1].context["session"]
        await session.execute(delete({{ JunctionModel }}).where(
            ({{ JunctionModel }}.{{ left_fk }} == leftId) & ({{ JunctionModel }}.{{ right_fk }} == rightId)
        ))
        return True

    return mutation, left, right
