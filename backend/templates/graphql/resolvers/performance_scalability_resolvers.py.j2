from ariadne import ObjectType
from sqlalchemy import select
{{ entity_import_line }}

def mount_performance_scalability_resolvers():
    query = ObjectType("Query")

    @query.field("{{ entities_connection_field }}")
    async def resolve_connection(*_, after: str=None, first: Int:=50, search: str=None, orderBy: str=None, order: str="ASC"):
        session = _[1].context["session"]
        model = {{ EntityModel }}
        stmt = select(model)
        if search and hasattr(model, "name"):
            stmt = stmt.where(model.name.ilike(f"%{search}%"))
        if orderBy and hasattr(model, orderBy):
            col = getattr(model, orderBy)
            stmt = stmt.order_by(col.asc() if order.upper()=="ASC" else col.desc())
        if after:
            stmt = stmt.where(model.id > after)
        stmt = stmt.limit(first + 1)
        res = await session.execute(stmt)
        rows = res.scalars().all()

        has_next = len(rows) > first
        rows = rows[:first]
        end_cursor = getattr(rows[-1], "id") if rows else None

        total = (await session.execute(select(model))).scalars().all()
        total_count = len(total)

        return {
            "totalCount": total_count,
            "edges": [{"node": r, "cursor": getattr(r, "id")} for r in rows],
            "pageInfo": {"hasNextPage": has_next, "endCursor": end_cursor},
        }

    return query
